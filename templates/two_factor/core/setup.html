{% extends 'two_factor/_base.html' %}
{% load i18n %}

{% block extra_media %}
  {{ form.media }}
{% endblock %}

{% block layout_content %}
  <style>
    .secret-key {
      font-family: monospace;
      font-size: 1.1rem;
      padding: 0.75rem 1rem;
      border: 1px dashed #6c757d;
      border-radius: 0.5rem;
      cursor: pointer;
      user-select: all;
    }
    
    .secret-key:hover {
      background-color: #f8f9fa;
    }
  </style>

  <div class="min-vh-100 d-flex align-items-center justify-content-center container-xl">
    <div class="card mx-auto" style="max-width: 600px; width: 100%;">
      <div class="card-header text-center">
        <a href="{% url 'core:index' %}"><img src="https://geausa.propensionesabogados.com/public/static/assets/imgs/logos/gea_logo_gold.webp" class="card-img-top img-fluid" alt="..." style="max-width: fit-content;" /></a>
      </div>

      <div class="card-body">
        {% if wizard.steps.current == 'welcome' %}
          <p>
            {% blocktrans trimmed %}Follow the steps in this wizard to enable two-factor authentication.{% endblocktrans %}
          </p>
        {% elif wizard.steps.current == 'method' %}
          <p>
            {% blocktrans trimmed %}Please select which authentication method you would like to use.{% endblocktrans %}
          </p>
        {% elif wizard.steps.current == 'generator' %}
          <div class="row">
            <div class="col-md-6">
              <div class="text-center">
                <img src="{{ QR_URL }}" alt="QR Code" class="bg-white text-center" style="max-width: 100%;" />
              </div>
            </div>

            <div class="col-md-6 d-flex flex-column justify-content-center">
              <div id="secret-key" class="secret-key text-center my-2" role="button" tabindex="0" title="{% trans 'Click to copy' %}" data-secret="{{ secret_key }}">{{ secret_key }}</div>
              <small id="copy-feedback" class="text-success mt-2 d-none">{% trans 'Copied to clipboard' %}</small>
            </div>
          </div>
        {% elif wizard.steps.current == 'validation' %}
          {% if challenge_succeeded %}
            <p class="alert alert-success">
              {% blocktrans %}Token validated successfully. Two-factor authentication is now enabled.{% endblocktrans %}
            </p>
          {% else %}
            <p class="alert alert-danger">
              {% blocktrans trimmed %}Token validation failed. Please try again.{% endblocktrans %}
            </p>
          {% endif %}
        {% endif %}

        <form action="" method="post">
          {% csrf_token %}
          {{ wizard.management_form }}

          {% if wizard.steps.current == 'generator' %}
            <div class="form-floating">
              <input type="number" class="form-control" name="generator-token" min="0" max="999999" autofocus="autofocus" inputmode="numeric" autocomplete="one-time-code" required id="id_generator-token" />
              <label for="id_generator-token">TOKEN</label>
            </div>
          {% endif %}

          <input type="submit" value="" hidden />

          <div class="d-grid gap-2 py-4">
            <button type="submit" class="btn btn-outline-success">{% trans 'Next' %}</button>

            {% if cancel_url %}
              <a type="button" href="{{ cancel_url }}" class="float-right btn btn-outline-danger">{% trans 'Cancel' %}</a>
            {% endif %}
          </div>
        </form>

        {% if request.user.is_authenticated %}
          {% comment 'TODO go to profile' %}
          <a href="{% url 'two_factor:login' %}">{% trans 'Back to login' %}</a>
          {% endcomment %}
        {% else %}
          <div class="small text-center">
            <a href="{% url 'two_factor:login' %}">{% trans 'Back to login' %}</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    (function () {
      const el = document.getElementById('secret-key')
      const feedback = document.getElementById('copy-feedback')
      if (!el) return
    
      function showOk() {
        if (!feedback) return
        feedback.classList.remove('d-none')
        setTimeout(() => feedback.classList.add('d-none'), 2000)
      }
    
      function fallbackCopy(text) {
        // Fallback compatible (aunque antiguo)
        const ta = document.createElement('textarea')
        ta.value = text
        ta.setAttribute('readonly', '')
        ta.style.position = 'fixed'
        ta.style.top = '-9999px'
        ta.style.left = '-9999px'
        document.body.appendChild(ta)
        ta.select()
        ta.setSelectionRange(0, ta.value.length) // mÃ³vil
    
        let ok = false
        try {
          ok = document.execCommand('copy')
        } catch (e) {
          ok = false
        }
    
        document.body.removeChild(ta)
        if (ok) showOk()
        return ok
      }
    
      async function copySecret() {
        const secret = el.dataset.secret || el.textContent.trim()
    
        // 1) Clipboard API (requiere contexto seguro + permisos)
        if (navigator.clipboard && window.isSecureContext) {
          try {
            await navigator.clipboard.writeText(secret)
            showOk()
            return
          } catch (err) {
            // si falla, cae al fallback
            fallbackCopy(secret)
            return
          }
        }
    
        // 2) Fallback
        fallbackCopy(secret)
      }
    
      el.addEventListener('click', (e) => {
        e.preventDefault()
        copySecret()
      })
    
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault()
          copySecret()
        }
      })
    })()
  </script>
{% endblock %}
