{% extends "two_factor/_base.html" %}
{% load i18n %}

{% block extra_media %}
  {{ form.media }}
{% endblock %}

{% block layout_content %}
  <div class="container-xl px-4">
    <div class="row justify-content-center">
      <div class="col-xl-7 col-lg-7 col-md-8 col-sm-11">
        <div class="card my-5">
          <div class="card-body p-3">
            <h1 class="h3 fw-light mb-3 text-center">{% block title %}{% trans "Enable Two-Factor Authentication" %}{% endblock %}</h1>
            {% if wizard.steps.current == 'welcome' %}
              <p>
                {% blocktrans trimmed %}You are about to take your account security to the
                  next level. Follow the steps in this wizard to enable two-factor
                  authentication.{% endblocktrans %}
              </p>
            {% elif wizard.steps.current == 'method' %}
                <p>{% blocktrans trimmed %}
                  Please select which authentication method you would
                  like to use.{% endblocktrans %}
                </p>
            {% elif wizard.steps.current == 'generator' %}
              <p>{% blocktrans trimmed %}To set up a token generator, scan the QR code below using an app like Google Authenticator, Authenticator from Windows or a similar app.{% endblocktrans %}</p>
              <div class="text-center"><img src="{{ QR_URL }}" alt="QR Code" class="bg-white text-center"/></div>
              <p>{% blocktrans trimmed %}Alternatively, use the following secret to configure the token manually in your authenticator or password manager.{% endblocktrans %}</p>
              <p>{% translate "TOTP Secret:" %} <a href="{{ otpauth_url }}">{{ secret_key }}</a></p>
              <p>{% blocktrans %}Then, enter the token generated by the app below to verify setup.{% endblocktrans %}</p>
            {% elif wizard.steps.current == 'validation' %}
              {% if challenge_succeeded %}
                <p class="alert alert-success">{% blocktrans %}Token validated successfully. Two-factor authentication is now enabled.{% endblocktrans %}</p>
              {% else %}
                <p class="alert alert-danger">{% blocktrans trimmed %}Token validation failed. Please try again.{% endblocktrans %}</p>
              {% endif %}
            {% endif %}
          </div>
          <hr class="my-0" />
          <div class="card-body p-5">
            <form action="" method="post">
              {% csrf_token %}
              {{ wizard.management_form }}
              
              {% if wizard.steps.current == 'generator' %}
                <div class="form-floating">
                  <input type="number" class="form-control" name="generator-token" min="0" max="999999" autofocus="autofocus" inputmode="numeric" autocomplete="one-time-code" required id="id_generator-token">
                  <label for="id_generator-token">TOKEN</label>
                </div>
              {% endif %}
                
              

              <input type="submit" value="" hidden />

              <div class="d-grid gap-2 py-4">
                <button type="submit" class="btn btn-outline-success">
                  {% trans "Next" %}
                </button>

                {% if cancel_url %}
                  <a type="button" href="{{ cancel_url }}" class="float-right btn btn-outline-danger">
                    {% trans "Cancel" %}
                  </a>
                {% endif %}
              </div>
            </form>
          </div>
          <hr class="my-0" />
          
          {% if request.user.is_authenticated %}
          {% comment "TODO go to profile" %}
            <a href="{% url 'two_factor:login' %}">
              {% trans "Back to login" %}
            </a>
          {% endcomment %}
          {% else %}
          <div class="card-body px-5 py-4">
            <div class="small text-center">
              <a href="{% url 'two_factor:login' %}">
                {% trans "Back to login" %}
              </a>
            </div>
          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
{% endblock %}
