{% extends "raw.html" %}
{% load static i18n %}

{% block title %}<title>{% trans "Asset Video Gallery" %}</title>{% endblock title %}

{% block content %}
<section class="container py-4 py-md-5">
  <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h3 mb-1">{% trans "Gallery" %}</h1>
      <p class="text-muted mb-0">{% trans "Multimedia content in a masonry layout." %}</p>
    </div>
    <div class="small text-muted">{{ total_items }} {% trans "files" %}</div>
  </div>

  {# Filtro por categor√≠a (GET) #}
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-12 col-sm-6 col-md-4">
      <label class="form-label mb-1">{% trans "Category" %}</label>
      <select class="form-select" name="cat" onchange="this.form.submit()">
        <option value="">{% trans "All" %}</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if current_cat|lower == c|lower %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-sm-auto">
      <a class="btn btn-outline-secondary" href="{% url 'video_masonry:gallery' %}">
        {% trans "Clear" %}
      </a>
    </div>
  </form>

  <div id="masonry" class="masonry">
    {% include "video_masonry/_media_grid.html" with items=items %}
  </div>

  <template id="skeleton-template">
    <article class="masonry-item card border-0 shadow-sm overflow-hidden">
      <div class="skeleton ratio ratio-4x3"></div>
      <div class="p-2">
        <div class="skeleton-line w-75 mb-2"></div>
        <div class="skeleton-line w-50"></div>
      </div>
    </article>
  </template>

  <div class="d-flex justify-content-center my-4">
    <div id="sentinel" class="py-2"></div>
  </div>

  <noscript>
    <div class="alert alert-warning">{% trans "Progressive loading requires JavaScript to be enabled." %}</div>
  </noscript>
</section>

<style>
  .masonry{ column-gap: 1rem; column-count: 1; }
  @media (min-width: 576px){ .masonry{ column-count: 2; } }
  @media (min-width: 992px){ .masonry{ column-count: 3; } }
  @media (min-width: 1400px){ .masonry{ column-count: 4; } }

  .masonry-item{
    display:inline-block; width:100%;
    margin:0 0 1rem; break-inside:avoid;
    border-radius:1rem;
  }

  .skeleton{ position:relative; overflow:hidden; background:rgba(0,0,0,.06); }
  .skeleton::after{
    content:""; position:absolute; inset:0; transform:translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.65), transparent);
    animation: shimmer 1.1s infinite;
  }
  @keyframes shimmer { 100% { transform: translateX(100%); } }

  .skeleton-line{
    height:.75rem; border-radius:.5rem; background:rgba(0,0,0,.06);
    position:relative; overflow:hidden;
  }
  .skeleton-line::after{
    content:""; position:absolute; inset:0; transform:translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.65), transparent);
    animation: shimmer 1.1s infinite;
  }

  .media-thumb{ width:100%; height:auto; display:block; }
  .media-caption{ font-size:.85rem; color:rgba(0,0,0,.55); }
</style>

<script>
(() => {
  const masonry = document.getElementById("masonry");
  const sentinel = document.getElementById("sentinel");
  const skeletonTpl = document.getElementById("skeleton-template");

  let nextPage = {{ next_page|default:"null" }};
  let loading = false;

  // Mantener filtro en infinite scroll
  const params = new URLSearchParams(window.location.search);
  const currentCat = params.get("cat") || "";

  function addSkeletons(count=8){
    const frag = document.createDocumentFragment();
    for(let i=0;i<count;i++) frag.appendChild(skeletonTpl.content.cloneNode(true));
    masonry.appendChild(frag);
  }

  function removeSkeletons(){
    masonry.querySelectorAll(".skeleton, .skeleton-line").forEach(el => {
      const card = el.closest(".masonry-item");
      if (card && card.querySelector(".skeleton") && !card.dataset.real) card.remove();
    });
  }

  function enforceNoAudio(){
    masonry.querySelectorAll("video[data-no-audio='1']").forEach(v => {
      v.muted = true;
      v.volume = 0.0;
      v.setAttribute("muted", "");
      v.addEventListener("volumechange", () => {
        v.muted = true;
        v.volume = 0.0;
      }, { passive: true });
    });
  }

  async function loadMore(){
    if(!nextPage || loading) return;
    loading = true;
    addSkeletons(10);

    try{
      const url = new URL("{% url 'video_masonry:gallery_fragment' %}", window.location.origin);
      url.searchParams.set("page", String(nextPage));
      if (currentCat) url.searchParams.set("cat", currentCat);

      const res = await fetch(url.toString(), { headers: { "X-Requested-With": "XMLHttpRequest" } });
      if(!res.ok) throw new Error("HTTP " + res.status);

      const html = await res.text();
      removeSkeletons();

      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      tmp.querySelectorAll(".masonry-item").forEach(it => it.dataset.real = "1");

      while(tmp.firstChild) masonry.appendChild(tmp.firstChild);

      const np = masonry.querySelector("[data-next-page]")?.getAttribute("data-next-page");
      nextPage = np ? parseInt(np, 10) : null;

      enforceNoAudio();
    } catch(e) {
      nextPage = null;
    } finally {
      loading = false;
    }
  }

  const io = new IntersectionObserver((entries) => {
    if(entries.some(e => e.isIntersecting)) loadMore();
  }, { rootMargin: "800px 0px" });

  io.observe(sentinel);
  enforceNoAudio();
})();
</script>
{% endblock content %}
