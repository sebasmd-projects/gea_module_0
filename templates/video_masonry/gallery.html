{% extends "raw.html" %}
{% load static i18n %}

{% block title %}<title>{% trans "Asset Video Gallery" %}</title>{% endblock title %}

{% block content %}
<section class="container py-4 py-md-5">
  <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h3 mb-1">{% trans "Gallery" %}</h1>
      <p class="text-muted mb-0">{% trans "Multimedia content layout." %}</p>
    </div>
    <div class="small text-muted">{{ total_items }} {% trans "files" %}</div>
  </div>

  <div id="masonry" class="masonry">
    {% include "video_masonry/_media_grid.html" with items=items %}
  </div>

  <nav class="d-flex justify-content-center gap-2 mt-4" aria-label="Pagination">
    {% if has_prev %}
      <a class="btn btn-outline-success" href="?page={{ prev_page }}">{% trans "Previous" %}</a>
    {% else %}
      <button class="btn btn-outline-success" disabled>{% trans "Previous" %}</button>
    {% endif %}

    <span class="align-self-center small text-muted">
      {% trans "Page" %} {{ page }}
    </span>

    {% if has_next %}
      <a class="btn btn-outline-success" href="?page={{ next_page }}">{% trans "Next" %}</a>
    {% else %}
      <button class="btn btn-outline-success" disabled>{% trans "Next" %}</button>
    {% endif %}
  </nav>
</section>

<style>
  .masonry{ column-gap: 1rem; column-count: 1; }
  @media (min-width: 576px){ .masonry{ column-count: 2; } }
  @media (min-width: 992px){ .masonry{ column-count: 3; } }
  @media (min-width: 1400px){ .masonry{ column-count: 4; } }

  .masonry-item{
    display:inline-block; width:100%;
    margin:0 0 1rem; break-inside:avoid;
    border-radius:1rem;
  }

  .media-thumb{ width:100%; height:auto; display:block; }
  .media-caption{ font-size:.85rem; color:rgba(0,0,0,.55); }
</style>

<style>
  .media-wrap{ position:relative; }

  .play-overlay{
    position:absolute;
    inset:0;
    border:0;
    background:transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
  }

  .play-icon{
    width:64px; height:64px;
    border-radius:999px;
    background:rgba(0,0,0,.45);
    position:relative;
    box-shadow:0 6px 24px rgba(0,0,0,.25);
  }
  .play-icon::before{
    content:"";
    position:absolute;
    left:26px; top:18px;
    width:0; height:0;
    border-left:18px solid rgba(255,255,255,.95);
    border-top:14px solid transparent;
    border-bottom:14px solid transparent;
  }

  /* Cuando está reproduciendo, ocultamos overlay */
  .is-playing .play-overlay{ display:none; }

  /* opcional: hover */
  .play-overlay:hover .play-icon{ background:rgba(0,0,0,.55); }
</style>


<script>
(() => {
  function getCookie(name) {
    const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return v ? v.pop() : '';
  }
  const csrftoken = getCookie("csrftoken");

  async function trackView(assetId){
    try{
      const form = new FormData();
      form.append("asset_id", String(assetId));
      await fetch("{% url 'video_masonry:track' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
        body: form
      });
    } catch(e){}
  }

  // Evita track duplicado por sesión (en esa página)
  const tracked = new Set();

  // Pausa cualquier otro video al reproducir uno
  function pauseOthers(currentVideo){
    document.querySelectorAll("video.js-video").forEach(v => {
      if (v !== currentVideo) {
        v.pause();
        v.controls = false;
        v.closest(".masonry-item")?.classList.remove("is-playing");
      }
    });
  }

  // Click en overlay o en el propio video
  document.addEventListener("click", async (ev) => {
    const playBtn = ev.target.closest(".js-play");
    const videoEl = ev.target.closest("video.js-video");

    let assetId = null;
    let v = null;

    if (playBtn) {
      assetId = playBtn.dataset.assetId;
      v = playBtn.parentElement.querySelector("video.js-video");
    } else if (videoEl) {
      assetId = videoEl.dataset.assetId;
      v = videoEl;
    } else {
      return;
    }

    if (!v) return;

    const card = v.closest(".masonry-item");
    const isPaused = v.paused;

    if (isPaused) {
      pauseOthers(v);
      v.controls = true;
      card?.classList.add("is-playing");

      // Track view SOLO la primera vez (por asset en esta carga)
      if (assetId && !tracked.has(assetId)) {
        tracked.add(assetId);
        trackView(assetId);
      }

      // intenta reproducir
      try { await v.play(); } catch(e) {}
    } else {
      v.pause();
      v.controls = false;
      card?.classList.remove("is-playing");
    }
  });

  // Si el usuario pausa desde controles, re-mostramos overlay
  document.addEventListener("pause", (ev) => {
    const v = ev.target;
    if (!(v instanceof HTMLVideoElement)) return;
    if (!v.classList.contains("js-video")) return;
    v.controls = false;
    v.closest(".masonry-item")?.classList.remove("is-playing");
  }, true);
})();
</script>

{% endblock content %}
