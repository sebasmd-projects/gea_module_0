{% extends 'account/layout/account.html' %}
{% load static i18n %}

{% block icons %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
<script src="https://kit.fontawesome.com/aa367a5aee.js" crossorigin="anonymous"></script>
{% endblock %}

{% block layout_content %}
<div class="min-vh-100 d-flex flex-column align-items-center justify-content-center container-xl px-5">
  <div class="card mx-auto" style="max-width: 800px; width: 100%;">
    <div class="card-header text-center">
      <a href="{% url 'core:index' %}">
          <img src="https://geausa.propensionesabogados.com/public/static/assets/imgs/logos/gea_logo_gold.webp"
          class="card-img-top img-fluid" alt="..." style="max-width: fit-content;" />
      </a>
    </div>

    <div class="card-body">
      <form method="POST">
        {{ wizard.form.media.css }}
        {% csrf_token %}
        {{ wizard.management_form }}

        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }}" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}

        {% if wizard.form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {% for error in wizard.form.non_field_errors %}
              <p class="mb-0">{{ error }}</p>
            {% endfor %}
          </div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted">
            {% trans "Step" %} {{ step_index }} / {{ step_count }}
          </div>
        </div>

        <div class="row g-1">
          {% with "account/partials/_floating_input.html" as floating_input %}

            {% if step_key == "user" %}
              <h4 class="mt-2">{% trans "User information" %}</h4>
              <div class="col-md-4">
                {% include floating_input with field=wizard.form.username label=_("Username*") disabled=True %}
              </div>
              <div class="col-md-4">
                {% include floating_input with field=wizard.form.first_name label=_("Names*") disabled=True %}
              </div>
              <div class="col-md-4">
                {% include floating_input with field=wizard.form.last_name label=_("Surnames*") disabled=True %}
              </div>
              <div class="col-md-6">
                {% include floating_input with field=wizard.form.user_type label=_("User type*") disabled=True %}
              </div>
              <div class="col-md-6" id="referred-wrapper">
                {% include floating_input with field=wizard.form.referred label=_("Referred By") disabled=True %}
              </div>
            {% endif %}

            {% if step_key == "security" %}
              <h4 class="mt-2">{% trans "Security information" %}</h4>
              <div class="col-md-6">
                {% include floating_input with field=wizard.form.password label=_("Password*") show_eye=True eye_target_id="register_password" disabled=True %}
              </div>
              <div class="col-md-6">
                {% include floating_input with field=wizard.form.confirm_password label=_("Confirm Password*") show_eye=True eye_target_id="register_confirm_password" disabled=True %}
              </div>
            {% endif %}

            {% if step_key == "contact" %}
              <h4 class="mt-2">{% trans "Contact information" %}</h4>
              <div class="col-md-2">
                {% include floating_input with field=wizard.form.phone_number_code label=_("Code*") disabled=True %}
              </div>
              <div class="col-md-5">
                {% include floating_input with field=wizard.form.phone_number label=_("Cell phone*") disabled=True %}
              </div>
              <div class="col-md-5">
                {% include floating_input with field=wizard.form.email label=_("Email*") disabled=True %}
              </div>
              <div class="col-md-6">
                {% include floating_input with field=wizard.form.confirm_email label=_("Confirm Email*") disabled=True %}
              </div>

              {% if wizard.form.user_type.value == "B" %}
              <div class="col-12 mt-1">
                <small class="text-muted">
                  {% trans "If you selected Buyer, we will email you a verification code after you continue." %}
                </small>
              </div>
              {% endif %}
            {% endif %}

            {% if step_key == "code" %}
              <h4 class="mt-2">{% trans "Unique code" %}</h4>
              <div class="col-md-6">
                {% include floating_input with field=wizard.form.unique_code label=_("Unique Code*") show_eye=True eye_target_id="register_unique_code" disabled=True %}
              </div>

              {% if wizard.form.user_type.value == "B" %}
              <div class="col-12 mt-1">
                <small class="text-muted">
                  {% trans "Buyers: enter the code sent to your email." %}
                </small>
              </div>
              {% else %}
              <div class="col-12 mt-1">
                <small class="text-muted">
                  {% trans "Suppliers: enter the daily code provided by your advisor." %}
                </small>
              </div>
              {% endif %}
            {% endif %}
          {% endwith %}
        </div>

        <div class="d-grid gap-2 mt-3">
          <div class="d-flex gap-2">
            {% if wizard.steps.prev %}
              <button
                type="submit"
                name="wizard_goto_step"
                value="{{ wizard.steps.prev }}"
                class="btn btn-outline-secondary w-50"
                formnovalidate
                disabled
              >
                {% trans "Back" %}
              </button>
            {% endif %}
            <button type="submit" class="btn btn-success {% if wizard.steps.prev %}w-50{% else %}w-100{% endif %}" disabled>
              {% if step_key == "code" %}{% trans "Register" %}{% else %}{% trans "Continue" %}{% endif %}
            </button>
          </div>

          <a class="btn btn-outline-dark" href="">
            {% trans 'Do you already have an account? Sign in' %}
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block body_custom_js %}
<script>
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.toggle-visibility');
    if (!btn) return;

    const targetSelector = btn.getAttribute('data-target');
    if (!targetSelector) return;

    const input = document.querySelector(targetSelector);
    if (!input) return;

    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
    input.setAttribute('type', type);

    const icon = btn.querySelector('i');
    if (icon) {
      icon.classList.toggle('bi-eye');
      icon.classList.toggle('bi-eye-slash');
    }
  });
</script>

<script>
  function toggleReferred() {
    const sel = document.getElementById('register_user_type');
    const wrap = document.getElementById('referred-wrapper');
    if (!sel || !wrap) return;

    const isBuyer = sel.value === "B";
    wrap.style.display = isBuyer ? "none" : "";
    if (isBuyer) {
      const input = wrap.querySelector('input,select,textarea');
      if (input) input.value = "";
    }
  }

  document.addEventListener('change', function (e) {
    if (e.target && e.target.name === "user-user_type") toggleReferred();
  });

  document.addEventListener('DOMContentLoaded', toggleReferred);
</script>
{{ wizard.form.media.js }}
{% endblock %}
