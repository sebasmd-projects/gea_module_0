{% extends 'dashboard/dashboard_layout_base.html' %}
{% load i18n static custom_filters %}

{# ===== ICONOS / CSS TERCEROS ===== #}
{% block simple_datatables %}
  <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
{% endblock %}

{% block icons %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js" crossorigin="anonymous"></script>
  <script src="https://kit.fontawesome.com/aa367a5aee.js" crossorigin="anonymous"></script>
{% endblock %}

{% block main_layout %}
    {# ===== URLs y assets reutilizables ===== #}
    {% url 'buyers:buyer_index' as purchase_orders_url %}
    {% url 'buyers:buyer_create' as add_purchase_order_url %}
    {% url 'assets:create' as add_asset_url %}

    {% static 'assets/imgs/illustrations/statistics.svg' as purchase_orders_image %}
    {% static 'assets/imgs/illustrations/windows.svg' as add_new_purchase_order_image %}
    {% static 'assets/imgs/illustrations/browser-stats.svg' as add_asset_image %}

    {% trans 'Purchase orders' as purchase_orders %}
    {% trans 'Add new purchase order' as add_new_purchase_order %}
    {% trans 'Add new asset' as add_new_asset %}
    {% trans 'Purchase Order Detail' as purchase_order_detail %}
    {% trans 'Purchase order detail and timeline/history' as purchase_order_detail_and_timeline %}
                                                              
    {% include 'dashboard/partials/header/_header.html' with  icon_class="me-2 fa-solid fa-magnifying-glass" page_title=purchase_order_detail page_description=purchase_order_detail_and_timeline parent_title=purchase_orders  parent_url=purchase_orders_url %}

  <div class="container-xl px-4 mt-n10">

    {% comment %}
    <!-- TODO: Cards para los usuarios que son HOLDERS (asset holders) -->
    {% if request.user.is_asset_holder or request.user.is_superuser %}
      <div class="row">
        {# ---- Card: Assets & Service Orders ---- #}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class='feather-xl text-green mb-3' icon_data_feather='archive' page_header_title=_('Assets and Service Orders') page_header_image=purchase_orders_image url=holder_index_url %}

        {# ---- Card: Add new asset (solo holders verificados) ---- #}
        {% if request.user.is_verified_holder %}
          {% include 'dashboard/partials/header/_header_card.html' with icon_class='feather-xl text-green mb-3' icon_data_feather='folder-plus' page_header_title=_('Add New Asset') page_header_image=add_asset_image url=add_asset_location_url %}
        {% endif %}
      </div>
    {% endif %}
    {% endcomment %}
      
    {% if request.user.is_buyer or request.user.is_superuser %}
      <div class="row">
        {% comment %} <!-- Purchase Orders Card --> {% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="file-text" page_header_title=purchase_orders page_header_image=purchase_orders_image url=purchase_orders_url %}

        {% comment %} <!-- Add New Purchase Order Card --> {% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="file-plus" page_header_title=add_new_purchase_order page_header_image=add_new_purchase_order_image url=add_purchase_order_url %}

        {% comment %}<!-- Add New Asset Card -->{% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="archive" page_header_title=add_new_asset page_header_image=add_asset_image url=add_asset_url %}
    </div>
    {% endif %}
        

    <div class="row">
      <div class="col-md-8">
        {# ====== RESUMEN DE LA OFERTA (tarjeta) ====== #}
        {% include 'dashboard/pages/buyers/partials/_offer_summary_card.html' with offer=offer user=user %}
      </div>

      <div class="col-md-4">
        {# ====== TIMELINE COMPLETO (se compone de parciales) ====== #}
        <div class="card">
          <div class="card-header" style="background-image: linear-gradient(to bottom, #c79c44 0%, #c89d46 50%, #f4d88b 100%);">
            <h4 class="text-center text-dark">{% trans 'Timeline' %}</h4>
          </div>
          
          <div class="card-body">
            <div class="timeline">
              {# ---- Purchase Order ---- #}
              {% include 'dashboard/pages/buyers/partials/timeline/_purchase_order.html' with offer=offer %}

              {# ---- Service Order ---- #}
              {% include 'dashboard/pages/buyers/partials/timeline/_service_order.html' with offer=offer %}

              {% if request.user.is_buyer or request.user.is_superuser %}
                {# ---- Payment Order ---- #}
                {% include 'dashboard/pages/buyers/partials/timeline/_payment_order.html' with offer=offer %}

                {# ---- Asset Sent ---- #}
                {% include 'dashboard/pages/buyers/partials/timeline/_asset_sent.html' with offer=offer %}

                {# ---- Profitability ---- #}
                {% include 'dashboard/pages/buyers/partials/timeline/_profitability.html' with offer=offer %}
              {% endif %}

              {# ---- End ---- #}
              {% include 'dashboard/pages/buyers/partials/timeline/_end.html' with offer=offer %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{# ===== JS ===== #}
{% block body_custom_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.feather) {
        feather.replace()
      }
    })
  </script>
{% endblock %}
