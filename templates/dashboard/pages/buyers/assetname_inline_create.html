{% extends 'dashboard/dashboard_layout_base.html' %}
{% load i18n static custom_filters %}

{% block icons %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/aa367a5aee.js" crossorigin="anonymous"></script>
{% endblock icons %}


{% block main_layout %}
    {% url 'buyers:buyer_index' as purchase_orders_url %}
    {% url 'assets:create' as add_asset_url %}
    {% url 'assets:add_category' as add_asset_category_url %}

    {% static 'assets/imgs/illustrations/statistics.svg' as purchase_orders_image %}
    {% static 'assets/imgs/illustrations/windows.svg' as add_new_purchase_order_image %}
    {% static 'assets/imgs/illustrations/processing.svg' as add_new_category_image %}

    {% trans 'Purchase Orders' as purchase_orders %}
    {% trans 'Create Asset Name & Asset' as create_asset_name_and_asset %}
    {% trans 'Register a new asset name and its category' as register_new_asset_name_and_category %}
    {% trans 'Add New Purchase Order' as add_new_purchase_order %}
    {% trans "Add New Asset" as add_new_asset %}
    {% trans "Add New Asset Category" as add_new_asset_category %}

    {% include 'dashboard/partials/header/_header.html' with icon_class="me-2" icon_data_feather="archive" page_title=create_asset_name_and_asset page_description=register_new_asset_name_and_category parent_title=purchase_orders parent_url=purchase_orders_url %}

<div class="container-xl px-4 mt-n10">
    <div class="row">
        {% comment %} <!-- Purchase Orders Card --> {% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="file-text" page_header_title=purchase_orders page_header_image=purchase_orders_image url=purchase_orders_url %}

        {% comment %}<!-- Add New Purchase Order Card -->{% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="file-plus" page_header_title=add_new_purchase_order page_header_image=add_new_purchase_order_image url=add_asset_url %}

        {% comment %}<!-- Add New Asset Category -->{% endcomment %}
        {% include 'dashboard/partials/header/_header_card.html' with icon_class="feather-xl text-green mb-3" icon_data_feather="list" page_header_title=add_new_asset_category page_header_image=add_new_category_image url=add_asset_category_url %}
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header"
                    style="background-image: linear-gradient(to bottom, #c79c44 0%, #c89d46 50%, #f4d88b 100%);">
                    <h2 style="color:black;">{% trans 'New Asset' %}</h2>
                </div>
                <div class="card-body">

                    {% if messages %}
                    <div class="mb-3">
                        {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show"
                            role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" novalidate id="inlineAssetForm">
                        {% csrf_token %}

                        {{ form.media.css }}
                        {{ name_form.media.css }}
                        {{ asset_form.media.css }}


                        <div class="card mb-3">
                            <div class="card-header">
                                <strong class="text-dark">{% trans 'Asset Name' %}</strong>
                            </div>
                            <div class="card-body">
                                {% if request.LANGUAGE_CODE == 'es' %}
                                <div class="mb-3">
                                    <label class="form-label" for="{{ name_form.es_name.id_for_label }}">
                                        {% trans 'Asset name (ES)' %}
                                    </label>
                                    {{ name_form.es_name|add_class:"form-control" }}
                                    {% if name_form.es_name.errors %}
                                    <div class="text-danger small">{{ name_form.es_name.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="mb-3">
                                    <label class="form-label" for="{{ name_form.en_name.id_for_label }}">
                                        {% trans 'Asset name (EN)' %}
                                    </label>
                                    {{ name_form.en_name|add_class:"form-control" }}
                                    {% if name_form.en_name.errors %}
                                    <div class="text-danger small">{{ name_form.en_name.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>



                        <div class="card mb-3">
                            <div class="card-header">
                                <strong class="text-dark">{% trans 'Asset Details' %}</strong>
                            </div>
                            <div class="card-body row">
                                <div class="mb-3 col-md-5">
                                    <label class="form-label" for="{{ asset_form.asset_img.id_for_label }}">
                                        {% trans 'Image' %}
                                    </label>
                                    {{ asset_form.asset_img|add_class:"form-control" }}
                                    {% if asset_form.asset_img.errors %}
                                    <div class="text-danger small">{{ asset_form.asset_img.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3 col-md-7 row">
                                    <div class="col-7">
                                        <label class="form-label" for="{{ asset_form.category.id_for_label }}">
                                            <span class="fw-bold">{% trans 'Category' %}*</span>
                                        </label>
                                        {{ asset_form.category|add_attrs:"class=form-select" }}
                                        {% if asset_form.category.errors %}
                                        <div class="text-danger small">
                                            {{ asset_form.category.errors|join:", " }}
                                        </div>
                                        {% endif %}
                                    </div>


                                    <div class="col-5 d-flex align-items-center d-grid gap-2">
                                        <a type="button" class="btn btn-outline-success mb-0"
                                            href="{% url 'assets:add_category' %}">
                                            <i class="fa-solid fa-plus mx-1"></i> {% trans 'Add New Category' %}
                                        </a>
                                    </div>
                                </div>


                                {% if request.LANGUAGE_CODE == 'es' %}

                                <div class="mb-3 col-md-6">
                                    <label class="form-label" for="{{ asset_form.es_description.id_for_label }}">
                                        {% trans 'Description (ES)' %}
                                    </label>
                                    {{ asset_form.es_description|add_class:"form-control" }}
                                    {% if asset_form.es_description.errors %}
                                    <div class="text-danger small">
                                        {{ asset_form.es_description.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3 col-md-6">
                                    <label class="form-label" for="{{ asset_form.es_observations.id_for_label }}">
                                        {% trans 'Observations (ES)' %}
                                    </label>
                                    {{ asset_form.es_observations|add_class:"form-control" }}
                                    {% if asset_form.es_observations.errors %}
                                    <div class="text-danger small">
                                        {{ asset_form.es_observations.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>

                                {% else %}
                                <div class="mb-3 col-md-6">
                                    <label class="form-label" for="{{ asset_form.en_description.id_for_label }}">
                                        {% trans 'Description (EN)' %}
                                    </label>
                                    {{ asset_form.en_description|add_class:"form-control" }}
                                    {% if asset_form.en_description.errors %}
                                    <div class="text-danger small">
                                        {{ asset_form.en_description.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="mb-3 col-md-6">
                                    <label class="form-label" for="{{ asset_form.en_observations.id_for_label }}">
                                        {% trans 'Observations (EN)' %}
                                    </label>
                                    {{ asset_form.en_observations|add_class:"form-control" }}
                                    {% if asset_form.en_observations.errors %}
                                    <div class="text-danger small">
                                        {{ asset_form.en_observations.errors|join:", " }}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>



                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-outline-success" id="saveBtn">
                                <i class="fa-solid fa-floppy-disk mx-1"></i>{% trans 'Save' %}
                            </button>

                            <a href="{% url 'buyers:buyer_create' %}" class="btn btn-outline-gold"
                                rel="noopener noreferrer">
                                <i class="fa-solid fa-arrow-left mx-1"></i> {% trans 'Add New Purchase Order' %}
                            </a>

                            <a href="{% url 'buyers:buyer_index' %}" class="btn btn-outline-gold"
                                rel="noopener noreferrer">
                                <i class="fa-solid fa-arrow-left mx-1"></i> {% trans 'Go to my Purchase Orders' %}
                            </a>
                        </div>
                    </form>

                </div>
            </div>

            {% if assets %}
            {# --- LISTADO INLINE DE ASSETS --- #}
            <div class="card mb-4">
                <div class="card-header"
                    style="background-image: linear-gradient(to bottom, #c79c44 0%, #c89d46 50%, #f4d88b 100%);">
                    <h2 style="color:black;">{% trans 'Existing Assets' %}</h2>
                </div>
                <div class="card-body">
                    <table id="assetinline_table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>{% trans 'Image' %}</th>
                                <th>{% trans 'Asset Name' %}</th>
                                <th>{% trans 'Category' %}</th>
                                <th>{% trans 'Description' %}</th>
                                <th>{% trans 'Observations' %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in assets %}
                            <tr>
                                <td>{{ forloop.counter }}</td>

                                <td>
                                    {% if a.asset_img %}
                                    <img src="{{ a.asset_img.url }}" alt="img"
                                        style="width:48px;height:48px;object-fit:cover;border-radius:6px;">
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>

                                <td>
                                    {% if request.LANGUAGE_CODE == 'es' %}
                                    {{ a.asset_name.es_name|default:"—" }}
                                    {% else %}
                                    {{ a.asset_name.en_name|default:"—" }}
                                    {% endif %}
                                </td>

                                <td>
                                    {% if request.LANGUAGE_CODE == 'es' %}
                                    {{ a.category.es_name|default:"—" }}
                                    {% else %}
                                    {{ a.category.en_name|default:"—" }}
                                    {% endif %}
                                </td>

                                <td style="max-width: 320px;">
                                    {% if request.LANGUAGE_CODE == 'es' %}
                                    {{ a.es_description|default_if_none:""|truncatechars:160 }}
                                    {% else %}
                                    {{ a.en_description|default_if_none:""|truncatechars:160 }}
                                    {% endif %}
                                </td>

                                <td style="max-width: 280px;">
                                    {% if request.LANGUAGE_CODE == 'es' %}
                                    {{ a.es_observations|default_if_none:""|truncatechars:120 }}
                                    {% else %}
                                    {{ a.en_observations|default_if_none:""|truncatechars:120 }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    {% trans 'No assets found.' %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


{% block body_custom_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $("#inlineAssetForm").on("submit", function () {
            $(this).find("button, a").prop("disabled", true).addClass("disabled");
            $("#saveBtn").html('<i class="fa-solid fa-spinner fa-spin mx-1"></i> {% trans "Saving and Translating..." %}');
            return true;
        });
    });
</script>
{{ form.media.js }}
{{ name_form.media.js }}
{{ asset_form.media.js }}
{% endblock %}

{% block simple_datatables %}
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
{% endblock %}

{% block simple_datatables_js %}
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js" crossorigin="anonymous"></script>
    <script src="{% static 'js/simple-datatable.js' %}"></script>
{% endblock %}